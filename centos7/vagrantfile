Vagrant.configure("2") do |config|
  RUNDECK_PKG="rundeckpro-enterprise-3.4.9.20211221-1"
  INSTANCE_IP="192.168.56.21"
  INSTANCE_PORT="4440"
  
  config.vm.box = "generic/centos7"
  
  config.vm.network "private_network", ip: INSTANCE_IP

  config.vm.provision "shell", inline: <<-SHELL
      instanceIp=#{INSTANCE_IP}
      instancePort=#{INSTANCE_PORT}
      rundeckPkg=#{RUNDECK_PKG}

repoData='[rundeckpro]
name=rundeckpro
baseurl=https://packages.rundeck.com/pagerduty/rundeckpro/rpm_any/rpm_any/$basearch
repo_gpgcheck=1
gpgcheck=0
enabled=1
gpgkey=https://packages.rundeck.com/pagerduty/rundeckpro/gpgkey
sslverify=1
sslcacert=/etc/pki/tls/certs/ca-bundle.crt
metadata_expire=300' 
      
      echo "$repoData" > /etc/yum.repos.d/rundeck.repo

      service firewalld stop
      yum update
      yum install java ${rundeckPkg} -y
      
      echo "Rundeck first start..."
      service rundeckd start

      while [[ $(tail -n 1 /var/log/rundeck/service.log) != *"Grails application running at http://"* ]]; do sleep 10; done
      service rundeckd stop
      echo "Setting host configuration..."

      sed -i "/^grails.serverURL.*=/s/=.*$/=http:\\/\\/${instanceIp}:${instancePort}/" /etc/rundeck/rundeck-config.properties
      sed -i "/^framework.server.name.*=/s/=.*$/= ${instanceIp}/" /etc/rundeck/framework.properties
      sed -i "/^framework.server.hostname.*=/s/=.*$/= ${instanceIp}/" /etc/rundeck/framework.properties
      sed -i "/^framework.server.url.*=/s/=.*$/= http:\\/\\/${instanceIp}:${instancePort}/" /etc/rundeck/framework.properties
      echo "Rundeck Server Configuration set."
      service rundeckd start

      echo "PACKAGE: ${rundeckPkg}"
      echo "SERVER IP: ${instanceIp}"
      echo "SERVER PORT: ${instancePort}"
   SHELL
end
